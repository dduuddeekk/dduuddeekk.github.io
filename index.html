<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Interaktif Bali</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script>
        // 1. Inisialisasi Data Lokasi
        const locations = {
            'rumah': { name: 'Rumah Saya', latlng: L.latLng(-8.671714, 115.199861), description: 'Jl. Gn. Kalimutu XIX No.21, Pemecutan Klod, Kec. Denpasar Bar., Kota Denpasar, Bali 80113', icon: L.icon({
                iconUrl: 'https://img.icons8.com/fluency/48/home.png',
                iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -40]
            }) },
            'kantor_desa': { name: 'Kantor Desa Pemecutan Kelod', latlng: L.latLng(-8.674589, 115.201776), description: 'Jl. Imam Bonjol No.180, Pemecutan Klod, Kec. Denpasar Bar., Kota Denpasar, Bali 80113', icon: L.icon({
                iconUrl: 'https://img.icons8.com/fluency/48/city-hall.png',
                iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -40]
            }) },
            'pasar': { name: 'Pasar Tegal Harum', latlng: L.latLng(-8.667280, 115.199540), description: 'Jl. Gunung Rinjani No.99X, Tegal Harum, Kec. Denpasar Bar., Kota Denpasar, Bali 80112', icon: L.icon({
                iconUrl: 'https://img.icons8.com/fluency/48/shopping-basket-2.png',
                iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -40]
            }) },
            'kampus': { name: 'Universitas Udayana-Teknologi Informasi', latlng: L.latLng(-8.796372, 115.176331), description: '653G+CGQ, Jl. Raya Kampus Udayana, Jimbaran, Kec. Kuta Sel., Kabupaten Badung, Bali 80361', icon: L.icon({
                iconUrl: 'https://img.icons8.com/fluency/48/university.png',
                iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -40]
            }) },
            'kantin': { name: 'Warung Robert Jr', latlng: L.latLng(-8.794983, 115.175958), description: 'Jl. Raya Kampus Unud No.88 Blok r, Jimbaran, Kec. Kuta Sel., Kabupaten Badung, Bali 80361', icon: L.icon({
                iconUrl: 'https://img.icons8.com/fluency/48/restaurant.png',
                iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -40]
            }) },
            'perpus': { name: 'Perpustakaan Jimbaran', latlng: L.latLng(-8.79887055526897, 115.17272843400745), description: '652F+95R Kampus Bukit, Jimbaran, Kec. Kuta Sel., Kabupaten Badung, Bali 80361', icon: L.icon({
                iconUrl: 'https://img.icons8.com/fluency/48/books.png',
                iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -40]
            }) }
        };

        // 2. Definisi Layer Peta Dasar (Basemap)
        let osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        });

        let satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
            attribution: '© Esri, DigitalGlobe, GeoEye, Earthstar Geographics'
        });

        // 3. Membuat Marker Secara Dinamis dari Objek 'locations'
        const locationMarkers = Object.values(locations).map(loc => {
            return L.marker(loc.latlng, { icon: loc.icon }).bindPopup(`<b>${loc.name}</b><br>${loc.description}`);
        });

        // 4. Membuat Layer Polygon untuk Area Tertentu
        let areaParkir = L.polygon([
            [-8.796319, 115.175951],
            [-8.796319, 115.175634],
            [-8.795871, 115.175653],
            [-8.795900, 115.175959]
        ], {
            color: '#009999',
            fillColor: '#00ffff',
            fillOpacity: 0.5
        }).bindPopup("<b>Area Parkir Fakultas Teknik</b>");

        // 5. Mengelompokkan Layer untuk Kontrol
        let markers = L.layerGroup(locationMarkers);
        
        // Deklarasi variabel untuk layer GeoJSON di luar fetch
        let batasAdministratifLayer = L.layerGroup();

        // 6. Inisialisasi Peta Utama
        let map = L.map('map', {
            center: [-8.409518, 115.188919],
            zoom: 10,
            layers: [osm, markers, areaParkir, batasAdministratifLayer]
        });

        // 7. Objek untuk Kontrol Layer
        let baseMaps = {
            "OpenStreetMap": osm,
            "Satellite": satellite
        };

        let overlayMaps = {
            "Titik Penting": markers,
            "Area Parkir": areaParkir,
            "Batas Administratif": batasAdministratifLayer
        };

        // 8. Menambahkan Kontrol Layer ke Peta
        L.control.layers(baseMaps, overlayMaps).addTo(map);

        // 9. Membuat Kontrol Kustom untuk Pemilihan Rute
        const routingControlUI = L.control({ position: 'topleft' });
        routingControlUI.onAdd = function (map) {
            const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
            container.style.backgroundColor = 'white';
            container.style.padding = '10px';
            container.style.borderRadius = '5px';
            container.style.fontFamily = 'sans-serif';
            container.style.width = '200px';
            L.DomEvent.disableClickPropagation(container);
            container.innerHTML = `
                <label for="start-location">Lokasi Awal:</label>
                <select id="start-location" style="width: 100%; margin-top: 5px;"></select>
                <br><br>
                <label for="end-location">Lokasi Akhir:</label>
                <select id="end-location" style="width: 100%; margin-top: 5px;"></select>
                <br><br>
                <div style="display: flex; justify-content: space-between;">
                    <button id="calculate-route" style="width: 48%;">Cari Rute</button>
                    <button id="reset-route" style="width: 48%;">Reset</button>
                </div>
            `;
            return container;
        };
        routingControlUI.addTo(map);

        // 10. Load and Display GeoJSON Data for Administrative Boundaries
        // Helper function to generate a random color
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        fetch('kelurahan.geojson')
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    style: function (feature) {
                        return {
                            color: 'blue',       
                            weight: 1,         
                            fillColor: getRandomColor(), 
                            fillOpacity: 0.6    
                        };
                    },
                    onEachFeature: function (feature, layer) {
                        if (feature.properties && feature.properties.nm_kelurahan) {
                            layer.bindPopup(`<b>Kelurahan:</b><br>${feature.properties.nm_kelurahan}`);
                        }
                    }
                }).addTo(batasAdministratifLayer);
            })
            .catch(error => console.error('Error loading GeoJSON:', error));


        // 11. Event Listener untuk Koordinat Klik
        map.on('click', function (e) {
            const lat = e.latlng.lat.toFixed(6);
            const lng = e.latlng.lng.toFixed(6);
            const popupContent = `<b>Koordinat Titik</b><br>Latitude: ${lat}<br>Longitude: ${lng}`;
            const newMarker = L.marker(e.latlng).bindPopup(popupContent).addTo(map);
            newMarker.openPopup();
            newMarker.on('popupclose', function () { map.removeLayer(newMarker); });
        });

        // 12. Logika Rute
        const startSelect = document.getElementById('start-location');
        const endSelect = document.getElementById('end-location');
        const calculateBtn = document.getElementById('calculate-route');
        const resetBtn = document.getElementById('reset-route');
        let currentRoute = null;

        function addDefaultOption(selectElement) {
            const defaultOption = document.createElement('option');
            defaultOption.value = ""; defaultOption.textContent = "-- Pilih Lokasi --";
            defaultOption.disabled = true; defaultOption.selected = true;
            selectElement.appendChild(defaultOption);
        }

        addDefaultOption(startSelect);
        addDefaultOption(endSelect);

        for (const key in locations) {
            const option1 = document.createElement('option');
            option1.value = key; option1.textContent = locations[key].name;
            startSelect.appendChild(option1);
            const option2 = document.createElement('option');
            option2.value = key; option2.textContent = locations[key].name;
            endSelect.appendChild(option2);
        }

        calculateBtn.addEventListener('click', function () {
            const startKey = startSelect.value;
            const endKey = endSelect.value;
            if (!startKey || !endKey) { alert("Silakan pilih lokasi awal dan akhir."); return; }
            if (startKey === endKey) { alert("Lokasi awal dan akhir tidak boleh sama."); return; }
            if (currentRoute) { map.removeControl(currentRoute); }
            currentRoute = L.Routing.control({
                waypoints: [locations[startKey].latlng, locations[endKey].latlng],
                routeWhileDragging: true, createMarker: function() { return null; },
                show: false, lineOptions: { styles: [{ color: '#009999', opacity: 0.75, weight: 8 }] }
            }).addTo(map);
        });

        resetBtn.addEventListener('click', function () {
            if (currentRoute) { map.removeControl(currentRoute); currentRoute = null; }
            startSelect.value = ""; endSelect.value = "";
        });
    </script>
</body>

</html>